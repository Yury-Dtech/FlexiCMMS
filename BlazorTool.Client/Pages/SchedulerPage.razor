@page "/scheduler"

@using System.Linq
@using BlazorTool.Client.Models
@using BlazorTool.Client.Services
@using BlazorTool.Client.Components
@using System.Text
@using System.Diagnostics
@using Telerik.Blazor.Components
@using Telerik.Blazor.Components.Scheduler
@using Telerik.DataSource.Extensions
@implements IAsyncDisposable
@inject IJSRuntime JSRuntime
@inject ApiServiceClient apiService
@inject AppointmentService ApptService
@inject NavigationManager Navigation
@inject UserState UserState
@inject AppStateService AppState
@inject ILogger<SchedulerPage> Logger
@inject IStringLocalizer<Resources.UIStrings> Localizer
@inject ViewSettingsService ViewSettingsService
@using Microsoft.AspNetCore.Components.Routing

@cellStyles
<CheckSession apiService="@apiService" UserState="@UserState" />

<div class="filter-controls-row">
        <div style="max-width: 400px;">
            <label>@Localizer["Scheduler_AssignedPersons"] </label>
            <TelerikMultiSelect Data="@PersonsNames"
                                @bind-Value="@selectedAssignedPersons"
                                TagMode="@MultiSelectTagMode.Multiple"
                                Placeholder="@Localizer["Scheduler_SelectAssignedPersons"]"
                                AutoClose="false"
                                Filterable="true"
                                FilterOperator="@Telerik.Blazor.StringFilterOperator.Contains"
                                OnChange="@OnPersonSelectChanged"
                                ShowClearButton="true"
                                Size="sm">

            </TelerikMultiSelect>
        </div>
        <div class="departments">
            <label>@Localizer["Scheduler_Department"] </label>
            <TelerikMultiSelect
                            Data="@Departments" TextField="Department"
                             Placeholder="@Localizer["Scheduler_SelectDepartment"]"
                             @bind-Value="@selectedDepartments"
                             AutoClose="false"
                             OnClose="@OnMultiDepartmentsClosed"
                             OnChange="@(async (arg) => { if (selectedDepartments.Count == 0) await LoadData(); })"
                             Filterable="true"
                             FilterOperator="@Telerik.Blazor.StringFilterOperator.Contains"
                             ShowClearButton="true"
                             Size="sm">
            </TelerikMultiSelect>
        </div>
        <div class="devices">
            <label>@Localizer["Scheduler_Device"] </label>
            <TelerikComboBox Data="@WO_AssetNo"
                             Placeholder="@Localizer["Scheduler_SelectAsset"]"
                             Filterable="true"
                             FilterOperator="@Telerik.Blazor.StringFilterOperator.Contains"
                             AllowCustom="true"
                             Value="@selectedAssetNo"
                             ValueChanged="@((string assetNo) => OnAssetNoChanged(assetNo))"
                             Size="sm"
                             class=@(customEditFormShown ? "" : "popup-target")>
            </TelerikComboBox>
        </div>
        <div class="ClearFilters-btn">
            <button class="ClearFilters-btn" @onclick="OnClearFilters" title="@Localizer["ClearFilters"]">
                @Localizer["ClearFilters"]
            </button>
        </div>
        <div class="refresh-timer" style="display:flex; align-items:center; gap:6px;">
            <div class="input--timer-interval" style="display: @timerSetVisibility;">
                <label style="padding-right:4px;">@Localizer["OrdersPage_RefreshInterval"]</label>
                <TelerikNumericTextBox @bind-Value="@TimerInterval"
                                       @key="TimerInterval"
                                        Min="1" Max="60" Width="70px" Size="sm"
                                        OnChange="@OnTimerIntervalChanged" />
                <span>@Localizer["OrdersPage_Minutes"]</span>
            </div>
            <Timer @ref="autoReloadTimer"
                    Interval="@HardReloadInterval"
                    OnTick="HardLoadDataTick"
                    AutoStart="true"
                    FireImmediately="false"
                    SkipIfBusy="true"
                    JitterMilliseconds="0"
                    SoftTickTimeout="@(TimeSpan.FromSeconds(1))">
                <ChildContent Context="ctx">
                    <div class="clickable-timer" @onclick="@OnTimerClick" style="cursor:pointer; font-size:0.8rem; line-height:1.1rem;">
                        @Localizer["NextUpdate"]: @(ctx.TimeLeft?.ToString("mm':'ss") ?? "-")<br />
                        @Localizer["LastUpdate"]: @(ctx.LastTickAt?.LocalDateTime.ToLongTimeString() ?? "-")
                    </div>
                </ChildContent>
            </Timer>
        </div>
</div>
<div class="scheduler-page-container">
    <div class="scheduler-container">
        <div style="display:flex; flex-direction: row; gap:16px; align-items:center; flex-wrap:wrap;">
            <div><p>@Localizer["Scheduler_ScheduledOrders"] @Appointments.Count()</p></div>
            <div><TelerikButton OnClick="@(async ()=> await HardLoadData())" Size="Small" ThemeColor="@ThemeConstants.Button.ThemeColor.Tertiary">@IconHtmlHelper.Refresh(20) @Localizer["Scheduler_ReloadAllData"]</TelerikButton></div>
            @if (CurrentView == SchedulerView.Timeline)
            {
                <div class="timeline-options">
                    <label>@Localizer["Scheduler_NumberOfDays"]</label>
                    <TelerikButtonGroup Class="telerikButtonGroup">
                        <ButtonGroupToggleButton OnClick="@(() => OnTimelineOptionChanged("3"))" Selected="@(selectedTimelineOption == "3")">3 </ButtonGroupToggleButton>
                        <ButtonGroupToggleButton OnClick="@(() => OnTimelineOptionChanged("5"))" Selected="@(selectedTimelineOption == "5")">5 </ButtonGroupToggleButton>
                        <ButtonGroupToggleButton OnClick="@(() => OnTimelineOptionChanged("7"))" Selected="@(selectedTimelineOption == "7")">7 </ButtonGroupToggleButton>
                        <ButtonGroupToggleButton OnClick="@(() => OnTimelineOptionChanged("14"))" Selected="@(selectedTimelineOption == "14")">14 </ButtonGroupToggleButton>
                        <ButtonGroupToggleButton OnClick="@(() => OnTimelineOptionChanged("Custom"))" Selected="@(selectedTimelineOption == "Custom")">@Localizer["Scheduler_Custom"]</ButtonGroupToggleButton>
                    </TelerikButtonGroup>
                </div>
                @if (showCustomTimelineInputs)
                {
                    <div style="display:flex; flex-direction: row; gap:6px; align-items:center; font-stretch: condensed;">
                        <label>@Localizer["Scheduler_ColumnWidth"]</label>
                        <TelerikNumericTextBox @bind-Value="@columnWidth" Width="80px" Min="10" Max="200" Step="10" Size="Small" />
                        <label>@Localizer["Scheduler_SlotDuration"]</label>
                        <TelerikNumericTextBox @bind-Value="@slotDuration" Width="110px" Min="15" Max="1440" Step="15" Size="Small" />
                        <label>@Localizer["Scheduler_NumberOfDays"]</label>
                        <TelerikNumericTextBox @bind-Value="@numberOfDays" Width="80px" Min="1" Max="30" Step="1" Size="Small" />
                    </div>
                }
            }
        </div>

        <TelerikScheduler TItem="SchedulerAppointment"
                          Id="Scheduler1"
                          Data="@Appointments"
                          @ref="SchedulerRef"
                          @bind-Date="SchedulerDate"
                          @bind-View="CurrentView"
                          AllowCreate="true"
                          AllowUpdate="true"
                          AllowDelete="true"
                          OnCreate="@OnCreateAppointment"
                          OnUpdate="@OnUpdateAppointment"
                          OnDelete="@OnDeleteAppointment"
                          OnEdit="@EditHandler"
                          OnCellRender="@OnSchedulerCellRender"
                          ConfirmDelete="true"
                          IdField="@nameof(SchedulerAppointment.WorkOrderID)"
                          StartField="@nameof(SchedulerAppointment.Start)"
                          EndField="@nameof(SchedulerAppointment.End)"
                          TitleField="@nameof(SchedulerAppointment.Title)"
                          DescriptionField="@nameof(SchedulerAppointment.WODesc)"
                          IsAllDayField="@nameof(SchedulerAppointment.IsAllDay)"
                          Height="100%">
            <SchedulerSettings>        
                <SchedulerGroupSettings Orientation="SchedulerGroupOrientation.Vertical" Resources="@(CurrentView == SchedulerView.Timeline ? new List<string> { "AssignedPerson" } : null)" />
            </SchedulerSettings>
            <SchedulerResources>
                <SchedulerResource Field="WOState" Title="WOState" Data="@statuses" />
                <SchedulerResource Field="AssignedPerson" Data="@PersonResources" ValueField="@nameof(Person.Name)" TextField="Name" />
            </SchedulerResources>
            <SchedulerViews>
                <SchedulerDayView   WorkDayStart="@WorkDayStart"
                                    WorkDayEnd="@WorkDayEnd"
                                    StartTime="@DayStart" 
                                    EndTime="@DayEnd">
                    <ItemTemplate>
                        @{
                            var item = (context as SchedulerAppointment) ?? new SchedulerAppointment();
                        }
                        <div style="height:100%;" @oncontextmenu:preventDefault @oncontextmenu="@((MouseEventArgs e) => ShowContextMenuFromAppointment(e, item))">
                            <SchedulerItem Item="@(item)" View="@SchedulerView.Day" />
                        </div>
                    </ItemTemplate>
                    <SlotTemplate>
                        @{
                            SchedulerSlotTemplateContext slot = context as SchedulerSlotTemplateContext;
                            <div class="context-menu-area" @oncontextmenu:preventDefault @oncontextmenu="@((MouseEventArgs e) => ShowContextMenuFromEmptySlot(e, slot))">
                            </div>
                        }
                    </SlotTemplate>
                </SchedulerDayView>
                <SchedulerWeekView 
                     WorkDayStart="@WorkDayStart"
                    WorkDayEnd="@WorkDayEnd"
                    StartTime="@DayStart" 
                    EndTime="@DayEnd">
                    <ItemTemplate>
                        @{
                            var item = (context as SchedulerAppointment) ?? new SchedulerAppointment();
                        }
                        <div style="height:100%;" @oncontextmenu:preventDefault @oncontextmenu="@((MouseEventArgs e) => ShowContextMenuFromAppointment(e, item))">
                            <SchedulerItem Item="@item" View="@SchedulerView.Week" />
                        </div>
                    </ItemTemplate>
                    <SlotTemplate>
                        @{
                            SchedulerSlotTemplateContext slot = context as SchedulerSlotTemplateContext;

                            <div class="context-menu-area" @oncontextmenu:preventDefault @oncontextmenu="@((MouseEventArgs e) => ShowContextMenuFromEmptySlot(e, slot))">
                            </div>
                        }
                    </SlotTemplate>
                </SchedulerWeekView>
                <SchedulerMonthView  ItemsPerSlot="4">
                    <ItemTemplate>
                        @{
                            var item = (context as SchedulerAppointment) ?? new SchedulerAppointment();
                        }
                        <div @oncontextmenu:preventDefault @oncontextmenu="@((MouseEventArgs e) => ShowContextMenuFromAppointment(e, item))">
                            <SchedulerItem Item="@item" View="@SchedulerView.Month" />
                        </div>
                    </ItemTemplate>
                    <SlotTemplate>
                        @{
                            SchedulerSlotTemplateContext slot = context as SchedulerSlotTemplateContext;
                            <span class="k-link k-nav-day">@slot.Start.Day</span>
                            <div class="context-menu-area" @oncontextmenu:preventDefault @oncontextmenu="@((MouseEventArgs e) => ShowContextMenuFromEmptySlot(e, slot))">
                            </div>
                        }
                    </SlotTemplate>
                </SchedulerMonthView>
                    <SchedulerTimelineView WorkDayStart="@WorkDayStart"
                                           WorkDayEnd="@WorkDayEnd"
                                           StartTime="@DayStart"
                                           EndTime="@DayEnd"
                                           NumberOfDays="@(numberOfDays ?? 3)"
                                           ColumnWidth="@(columnWidth ?? 15)" SlotDivisions="@(slotDivisions ?? 1)" SlotDuration="@(slotDuration ?? 15)">
                    <ItemTemplate>
                        @{
                            var item = (context as SchedulerAppointment) ?? new SchedulerAppointment();
                        }
                        <div @oncontextmenu:preventDefault @oncontextmenu="@((MouseEventArgs e) => ShowContextMenuFromAppointment(e, item))">
                            <SchedulerItem Item="@item" View="@SchedulerView.Timeline" />
                        </div>
                    </ItemTemplate>
                    <SlotTemplate>
                        @{
                            SchedulerSlotTemplateContext slot = context as SchedulerSlotTemplateContext;
                            <div class="context-menu-area" @oncontextmenu:preventDefault @oncontextmenu="@((MouseEventArgs e) => ShowContextMenuFromEmptySlot(e, slot))">
                            </div>
                        }
                    </SlotTemplate>

                </SchedulerTimelineView>
            </SchedulerViews>
        </TelerikScheduler>

        <TelerikLoaderContainer Visible="@isLoading" Text="@Localizer["Scheduler_LoadingAppointments"]" Size="@Telerik.Blazor.ThemeConstants.Loader.Size.Large">
        </TelerikLoaderContainer>


        @if (CurrentView == SchedulerView.Timeline)
        {
            <SchedulerSummary Appointments="@Appointments" />
        }
    </div>

    <TelerikContextMenu TItem="ContextMenuItem" @ref="@ContextMenuRef" Data="@MenuItems" OnClick="@OnMenuItemClick" Class="custom-context-menu" />

    <div class="orders-grid-container">
        @if (isLoading)
        {
            <div style="display:flex; justify-content:space-between; align-items: center; align-content: center">
                <p>@Localizer["Scheduler_LoadingOrders"]</p>
            </div>
        }
        else
        {
            <div class="p-2" style="display:flex; justify-content:space-between; align-items: center;">
                <p>@Localizer["Scheduler_OrdersWithoutStartDate"] @UntakenOrders.Count()</p>
                <div style="display:flex; align-items:center; gap: 5px;">
                    <TelerikCheckBox Size="lg" OnChange="@OnCBAllOrdersChanged" Id="OrdersCheckBox" @bind-Value="@isCBAllOrdersSelected" />
                    <label for="OrdersCheckBox">@Localizer["Scheduler_ShowCompletedOrders"] </label>
                </div>
            </div>
            <TelerikTooltip TargetSelector=".tooltip-target"  />
            <TelerikGrid TItem="WorkOrder"
                         @ref="ordersGrid"
                         Data="@UntakenOrders"
                         RowDraggable="true"
                         OnRowDrop="@GridRowDrop"
                         Sortable="true"
                         Height="95%"
                         FilterMode="@GridFilterMode.FilterMenu"
                         OnRowDoubleClick="@OnRowClick"
                         OnStateChanged="@( (GridStateEventArgs<WorkOrder> args) => { _viewSettings.GridState = args.GridState;  SaveFilterStateToCacheAsync(); })">

                <RowTemplate Context="order">
                    <td class="tooltip-target" title="@order?.WODesc">@order?.AssetNo</td>
                    <td class="tooltip-target" title="@order?.WODesc">@order?.WOCategory</td>
                    <td class="tooltip-target" title="@order?.AddDate">@order?.AddDate?.ToString("dd/MM/yyyy HH:mm")</td>
                    <td class="state-@order?.StateColor?.TrimStart('#') tooltip-target" title="@order?.WOState">@order?.WOState</td>
                </RowTemplate>

                <GridSettings>
                    <GridRowDraggableSettings DragClueField="@nameof(WorkOrder.WorkOrderID)" />
                </GridSettings>


                <GridColumns>
                    <GridColumn Field="@nameof(WorkOrder.AssetNo)" Title="@Localizer[nameof(WorkOrder.AssetNo)]">
                        <FilterMenuTemplate>
                            <MultiSelectFilterMenuTemplate Values="@UntakenOrders.Select(x => x.AssetNo).Distinct()"
                                                           context="@context"
                                                           NameOfField="@nameof(WorkOrder.AssetNo)">
                            </MultiSelectFilterMenuTemplate>
                        </FilterMenuTemplate>
                    </GridColumn>
                    <GridColumn Field="@nameof(WorkOrder.WOCategory)" Title="@Localizer[nameof(WorkOrder.WOCategory)]">
                        <FilterMenuTemplate>
                            <CheckBoxFilterMenuTemplate Values="@WOCategories"
                                                        context="@context"
                                                        NameOfField="@nameof(WorkOrder.WOCategory)">
                            </CheckBoxFilterMenuTemplate>
                        </FilterMenuTemplate>
                    </GridColumn>
                    <GridColumn Field="@nameof(WorkOrder.AddDate)" Title="@Localizer[nameof(WorkOrder.AddDate)]">
                        <FilterMenuButtonsTemplate Context="filterContext">
                            <div class="vertical-stack-container">

                                <div class="stack-item">
                                    <TelerikButton ThemeColor="@ThemeConstants.Button.ThemeColor.Primary" OnClick="@(async _ => await filterContext.FilterAsync())">@Localizer["OrdersPage_Filter"] </TelerikButton>
                                    <TelerikButton ThemeColor="@ThemeConstants.Button.ThemeColor.Info" OnClick="@(() => filterContext.ClearFilterAsync())">@Localizer["OrdersPage_Clear"]</TelerikButton>
                                </div>
                                <div class="stack-item">
                                    <TelerikButton OnClick="@(() => FilterByDateRange(filterContext, "AddDate", "year"))">@Localizer["OrdersPage_LastYear"]</TelerikButton>
                                    <TelerikButton OnClick="@(() => FilterByDateRange(filterContext, "AddDate", "quarter"))">@Localizer["OrdersPage_Quarter"]</TelerikButton>
                                    <TelerikButton OnClick="@(() => FilterByDateRange(filterContext, "AddDate", "month"))">@Localizer["OrdersPage_Month"]</TelerikButton>
                                </div>
                            </div>

                        </FilterMenuButtonsTemplate>
                    </GridColumn>
                    <GridColumn Field="@nameof(WorkOrder.WOState)" Title="@Localizer[nameof(WorkOrder.WOState)]">
                        <FilterMenuTemplate>
                            <CheckBoxFilterMenuTemplate Values="@WOStates"
                                                        context="@context"
                                                        NameOfField="@nameof(WorkOrder.WOState)">
                            </CheckBoxFilterMenuTemplate>
                        </FilterMenuTemplate>
                    </GridColumn>
                </GridColumns>

            </TelerikGrid>
        }
    </div>
</div>

<TelerikWindow Modal="false" MinWidth="1200px" MaxHeight="95vh" Visible="@customEditFormShown" ThemeColor="@ThemeConstants.Window.ThemeColor.Dark">
    <WindowTitle>@Localizer["WorkOrder_OrderNo"]@CurrentAppointment.WorkOrderID</WindowTitle>
    <WindowActions>
        <WindowAction Name="Close" OnClick="@CancelEditing" />
    </WindowActions>
    <WindowContent>
        <AppointmentEditor Appointment="@CurrentAppointment"
                           isEditable=@(UserState.HasPermission(PermissionType.WO_Edit) || (CurrentAppointment.AppointmentId ==0 && UserState.HasPermission(PermissionType.WO_Add)))
                           ListPersons="@PersonsNames.Where(c=>c != "All").ToList()"
                           currentUser="@currentUser"
                           OnComponentClosing="@RefreshData"
                           isScheduler="true" />
    </WindowContent>
</TelerikWindow>

<TelerikWindow Modal="false" MinWidth="1200px" MaxHeight="95vh" Visible="@isOrderCardOpen" ThemeColor="@ThemeConstants.Window.ThemeColor.Dark">
    <WindowTitle>WorkOrder #@CurrentOrder.WorkOrderID</WindowTitle>
    <WindowActions>
        <WindowAction Name="Close" OnClick="@CancelEditing" />
    </WindowActions>
    <WindowContent>
        <WorkOrderComponent currentUser="@currentUser" ListPersons="@PersonsNames.Where(c=>c != "All").ToList()" WorkOrder="@CurrentOrder" isEditable=@UserState.HasPermission(PermissionType.WO_Edit)/>
    </WindowContent>
</TelerikWindow>

<TelerikPopup @ref="@PopupRef"
              AnchorSelector=".popup-target"
              AnchorHorizontalAlign="@PopupAnchorHorizontalAlign.Center"
              AnchorVerticalAlign="@PopupAnchorVerticalAlign.Center"
              AnimationType="@AnimationType.SlideDown"
              AnimationDuration="200"
              Width="300px"
              Height="300px">
    <div Class="warning-popup">
        <p>@popupMessage</p>
        <TelerikButton OnClick="@(() => PopupRef?.Hide())"
                       Icon="@SvgIcon.XCircle">Close</TelerikButton>
    </div>

</TelerikPopup>

@code {
    private string SchedulerSettingsKey = ViewSettingsService.SettingsKeys["SchedulerPage"];
    private List<SchedulerAppointment> Appointments { get; set; } = new();
    private List<SchedulerAppointment> _allAppointments { get; set; } = new();
    private TelerikScheduler<SchedulerAppointment>? SchedulerRef { get; set; }
    private TelerikPopup? PopupRef { get; set; }
    private TelerikGrid<WorkOrder> ordersGrid { get; set; }
    private DateTime SchedulerDate { get; set; } = DateTime.Today;
    private SchedulerView CurrentView { get; set; } = SchedulerView.Month;
    private DateTime DayStart => DateTime.Today.AddHours(7);
    private DateTime DayEnd => DateTime.Today.AddHours(20);
    private DateTime WorkDayStart = new DateTime(2000, 1, 1, 8, 0, 0);
    private DateTime WorkDayEnd = new DateTime(2000, 1, 1, 16, 0, 0);
    private MarkupString cellStyles = new MarkupString(); //for rows colors
    private List<WorkOrder> UntakenOrders { get; set; } = new();
    private List<WorkOrder> TakenOrders { get; set; } = new();
    private List<WorkOrder> _allOrders = new();
    private bool isLoading { get; set; } = true;
    private bool customEditFormShown { get; set; } = false;
    private bool isOrderCardOpen = false;
    private SchedulerAppointment CurrentAppointment { get; set; } = new SchedulerAppointment();
    private WorkOrder CurrentOrder { get; set; } = new WorkOrder();
    private List<Person> allPersons = new();
    private List<Person> PersonResources { get; set; } = new();
    private List<string> selectedAssignedPersons = new();
    private List<string> PersonsNames = new();
    private List<string> Departments = new();
    private List<string> WOCategories = new();
    private List<string> WOStates = new();
    private List<string> selectedDepartments = new List<string>();
    private bool isCBAllOrdersSelected = false; //show executed orders in grid
    private bool isAllOrdersLoaded = false; //to avoid reloading orders when switching checkbox
    private List<string> DeviceCategories = new();//for Orders grid filter
    private string selectedCategory = "All";
    private List<string> WO_AssetNo = new();
    private string selectedAssetNo = "All";
    private Person currentUser = new Person();
    private string popupMessage = string.Empty;
    private int? columnWidth = 50; //for TimelineView alt=80
    private int? slotDuration = 180; //in minutes for TimelineView
    private int? slotDivisions = 1; //for TimelineView
    private int? numberOfDays = 5; //for TimelineView alt=3
    private string selectedTimelineOption = "5";
    private bool showCustomTimelineInputs = false;
    private List<Resource> statuses = new List<Resource>();
    private ViewSettings<WorkOrder> _viewSettings = new ViewSettings<WorkOrder>();
    private System.Threading.Timer _saveStateTimer;
    private const int SaveStateDelay = 500; // ms
    // Auto refresh timer
    private int TimerInterval { get; set; } = 4; // minutes
    private TimeSpan HardReloadInterval { get; set; }
    private BlazorTool.Client.Components.Timer? autoReloadTimer;
    private string timerSetVisibility = "none";
    private bool _navSubscribed; // tracking NavigationManager subscription

    private List<Resource> GetStatuses(List<SchedulerAppointment> appointments)
    {
        List<Resource> resources = new List<Resource>();
        if (UserState.UseOriginalColors)
        {
            var st = appointments.Select(a => a.WOState).Distinct().ToList();
            foreach (var s in st)
            {
                var status = new Resource
                {
                    Text = s,
                    Value = s,
                    Color = appointments.FirstOrDefault(a => a.WOState == s)?.StateColor ?? "LightGray"
                };
                resources.Add(status);
            }
        }
        else
            resources = new List<Resource>
            {
                new Resource { Text = @Localizer["Scheduler_NotStarted"], Value = "Nie rozpoczęte", Color = "LightCoral" },
                new Resource { Text = @Localizer["Scheduler_InProgress"], Value = "W trakcie realizacji", Color = "LightYellow" },
                new Resource { Text = @Localizer["Scheduler_InProgress"], Value = "Zawieszone", Color = "lightsteelblue" },
                new Resource { Text = @Localizer["Scheduler_Completed"], Value = "Zakończony", Color = "LightGreen" },
                new Resource { Text = @Localizer["Scheduler_Completed"], Value = "Zakończone", Color = "LightGreen" },
            };
        return resources;
    }

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine($"[NAV] SchedulerPage.razor: OnInitializedAsync at {DateTime.Now:HH:mm:ss}");
        if (!_navSubscribed)
        {
            Navigation.LocationChanged += OnLocationChanged;
            _navSubscribed = true;
        }
        await base.OnInitializedAsync();

        _viewSettings = await ViewSettingsService.LoadSettingsAsync<WorkOrder>(SchedulerSettingsKey);
        if (_viewSettings != null)
        {
            RestoreCustomFilterState();
        }
        HardReloadInterval = TimeSpan.FromMinutes(TimerInterval);

        var isWASM = JSRuntime is IJSInProcessRuntime;
        Console.WriteLine($"--- Initialized SCHEDULER PAGE. WASM = {isWASM}");
        Console.WriteLine($"--- OnInitializedAsync completed.");
        await UserState.InitializationTask; // Ensure UserState is loaded

        if (int.TryParse(selectedTimelineOption, out int days))
        {
            numberOfDays = days;
        }
        WorkDayStart = UserState.WorkDayStart ?? WorkDayStart;
        WorkDayEnd = UserState.WorkDayEnd ?? WorkDayEnd;
        InitializeSaveStateTimer(); 

        await HardLoadData();
        await InvokeAsync(StateHasChanged);
        if (_viewSettings != null) await ordersGrid.SetStateAsync(_viewSettings.GridState);
    }

    private async Task HardLoadData(bool showLoading = true)
    {
        Console.WriteLine("--- HardLoadData started.");
        if (showLoading) isLoading = true;
        if (showLoading) StateHasChanged();
        if (!UserState.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        allPersons = apiService.GetAllPersonsCached();
        if (allPersons == null || allPersons.Count == 0)
            allPersons = await apiService.GetAllPersons();
        Console.WriteLine($"--- HardLoadData: allPersons loaded. Count: {allPersons.Count}");
        PersonsNames = allPersons.Select(c => c.Name).ToList();
        PersonsNames.Insert(0, Person.NotAssigned.Name);
        if (isCBAllOrdersSelected) isAllOrdersLoaded = true;
        _allOrders = await apiService.GetWorkOrdersAsync(lang: UserState.LangCode, active: isCBAllOrdersSelected == true ? null : true); 
        cellStyles = RenderStatesStyle(_allOrders);
        ApptService.ClearAppointments(); 
        WOCategories = (await apiService.GetWOCategories()).Select(c => c.Name).ToList();
        WOStates = (await apiService.GetWOStates()).Select(c => c.Name).ToList();
        currentUser.PersonId = UserState.PersonID ?? -1;
        currentUser.Name = UserState.UserName ?? string.Empty;
        await LoadData(showLoading);
        Console.WriteLine($"--- HardLoadData completed. UntakenOrders count: {UntakenOrders.Count}, Appointments count: {Appointments.Count}");
    }

    private async Task HardLoadDataTick()
    {
        var oldCount = Appointments.Count;
        Console.WriteLine($"[TIMER] SchedulerPage HardLoadDataTick at {DateTime.Now:HH:mm:ss}");
        await HardLoadData(false);
        var newCount = Appointments.Count;
        if (newCount != oldCount)
        {
        }
    }

    private async Task LoadData(bool showLoading = true)
    {
        Console.WriteLine("--- LoadData started.");
        if (showLoading) isLoading = true;
        if (showLoading) StateHasChanged();
        _allOrders = await apiService.GetWorkOrdersCachedAsync(active: isCBAllOrdersSelected == true ? null : true);
        _allAppointments = await ApptService.GetTakenAppointments(_allOrders);
        statuses = GetStatuses(_allAppointments);
        Console.WriteLine($"--- LoadData: _allAppointments loaded. Count: {_allAppointments.Count}");
        Departments = (await apiService.GetWODepartments()).Select(c => c.Name).Distinct().ToList();
        DeviceCategories = (await apiService.GetWOCategories()).Select(c => c.Name).Distinct().ToList();
        DeviceCategories.Insert(0, "All");
        WO_AssetNo = new List<string> { "All" };
        WO_AssetNo.AddRange(_allOrders.Where(d => !string.IsNullOrWhiteSpace(d.AssetNo ?? "")).Select(x => x.AssetNo ?? "").Distinct().ToList());
        DisplayAppointments();
        DisplayOrders();
        if (showLoading) isLoading = false;
        StateHasChanged();
        Console.WriteLine($"--- LoadData completed. UntakenOrders count: {UntakenOrders.Count}, Appointments count: {Appointments.Count}");
    }

    private void OnTimerIntervalChanged()
    {
        HardReloadInterval = TimeSpan.FromMinutes(TimerInterval);
        _viewSettings.SetCustomFilter("TimerInterval", TimerInterval);
        _saveStateTimer?.Change(SaveStateDelay, Timeout.Infinite);
        _ = autoReloadTimer?.RestartAsync();
    }

    private void OnTimerClick()
    {
        timerSetVisibility = string.IsNullOrEmpty(timerSetVisibility) ? "none" : string.Empty;
        StateHasChanged();
    }

    // Handle navigation away from the Scheduler page to stop the timer
    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        if (!e.Location.Contains("/scheduler", StringComparison.OrdinalIgnoreCase))
        {
            _ = DisposeTimerAsync();
        }
    }

    private async Task DisposeTimerAsync()
    {
        try
        {
            if (autoReloadTimer != null)
            {
                await autoReloadTimer.DisposeAsync();
                autoReloadTimer = null;
            }
        }
        catch { }
    }

    private void DisplayAppointments()
    {
        var appointments = FilterAppointments();
        Appointments = appointments;
        if (selectedAssignedPersons.Count == 0)
        {
            PersonResources = new List<Person>(allPersons);
        }
        else
        {
            PersonResources = allPersons.Where(p => selectedAssignedPersons.Contains(p.Name)).ToList();
        }

        if ((selectedAssignedPersons.Contains(Person.NotAssigned.Name) || selectedAssignedPersons.Count == 0) && !PersonResources.Any(p => p.Name == Person.NotAssigned.Name))
        {
            PersonResources.Insert(0, Person.NotAssigned);
        }       
        _viewSettings.SetCustomFilter("TimerInterval", TimerInterval);
        _saveStateTimer?.Change(SaveStateDelay, Timeout.Infinite);
    }

    private void DisplayOrders()
    {       
        var orders = FilterOrders();
        UntakenOrders = orders;
        cellStyles = RenderStatesStyle(orders);
    }

    private async Task OnCBAllOrdersChanged()
    {
        if (!isAllOrdersLoaded && isCBAllOrdersSelected)
            await HardLoadData(true);
        else
            DisplayOrders();
    }

    private async Task GridRowDrop(GridRowDropEventArgs<WorkOrder> args)
    {
        if (!UserState.HasPermission(PermissionType.WO_Edit)) return;

        if (args.DestinationComponentId == "Scheduler1" && SchedulerRef != null)
        {
            var slot = SchedulerRef.GetTimeSlotFromDropIndex(args.DestinationIndex);
            bool isTimelineView = CurrentView == SchedulerView.Timeline;
            object resourceValue = Person.NotAssigned.Name; 
            if (isTimelineView)
            {
                var resourceKvp = slot.Resources.FirstOrDefault(kvp => kvp.Key == "AssignedPerson");
                if (resourceKvp.Key != null) 
                {
                    resourceValue = resourceKvp.Value;
                }
            }

            foreach (var wo in args.Items)
            {
                var newAppointment = new SchedulerAppointment(wo)
                {
                    Start = slot.Start,
                    End = slot.Start.AddHours(8),
                    IsAllDay = slot.IsAllDay,
                    TakeDate = slot.Start,
                    AssignedPerson = isTimelineView ? (resourceValue as string ?? Person.NotAssigned.Name) : wo.AssignedPerson
                };

                var result = await ApptService.UpdateAppointment(newAppointment);
                if (result.IsValid)
                {
                    Appointments.Add(newAppointment);
                    _allAppointments.Add(newAppointment);
                    UntakenOrders.Remove(wo);
                }
                else
                {
                    Console.WriteLine($"Failed to update appointment on drop: {string.Join(", ", result.Errors)}");

                    CurrentAppointment = newAppointment;
                    customEditFormShown = true;
                }
            }

            SchedulerRef.Rebind();
        }
    }

    #region filters

    private void OnMultiDepartmentsClosed()
    {
        DisplayAppointments();
        SaveFilterStateToCacheAsync();
    }

    private void OnAssetNoChanged(string assetNo)
    {
        selectedAssetNo = assetNo ?? "All";
        DisplayAppointments();
        SaveFilterStateToCacheAsync();
    }

    private void OnPersonSelectChanged(object args)
    {
        DisplayAppointments();
        SaveFilterStateToCacheAsync();
    }

    private List<SchedulerAppointment> FilterAppointments()
    {
        var filteredAppointments = new List<SchedulerAppointment>(_allAppointments);
        if (selectedDepartments.Any())
        {
            filteredAppointments = filteredAppointments.Where(a => selectedDepartments.Contains(a.DepName)).ToList();
        }
        if (!string.IsNullOrEmpty(selectedAssetNo) && selectedAssetNo != "All")
        {
            filteredAppointments = filteredAppointments.Where(a => a.AssetNo == selectedAssetNo).ToList();
        }
        if (selectedAssignedPersons.Count > 0)
        {
            bool isNotAssignedSelected = selectedAssignedPersons.Contains(Person.NotAssigned.Name);
            filteredAppointments = filteredAppointments.Where(a => selectedAssignedPersons.Contains(a.AssignedPerson) ||
            (isNotAssignedSelected && string.IsNullOrEmpty(a.AssignedPerson))).ToList();
        }
        return filteredAppointments;
    }

    private void SaveFilterStateToCacheAsync()
    {
        _viewSettings.SetCustomFilter("selectedAssignedPersons", selectedAssignedPersons);
        _viewSettings.SetCustomFilter("selectedDeviceCategory", selectedAssetNo);
        _viewSettings.SetCustomFilter("selectedDepartments", selectedDepartments);
        _viewSettings.SetCustomFilter("CurrentView", CurrentView);
        _viewSettings.SetCustomFilter("TimerInterval", TimerInterval);
        _saveStateTimer?.Change(SaveStateDelay, Timeout.Infinite);       
    }

    private void RestoreCustomFilterState()
    {
        selectedAssignedPersons = _viewSettings.GetCustomFilter("selectedAssignedPersons", new List<string>());
        selectedAssetNo = _viewSettings.GetCustomFilter("selectedAssetNo", "All");
        selectedDepartments = _viewSettings.GetCustomFilter("selectedDepartments", new List<string>());
        CurrentView = _viewSettings.GetCustomFilter("CurrentView", SchedulerView.Month);
        TimerInterval = _viewSettings.GetCustomFilter("TimerInterval", 6);
    }

    private List<WorkOrder> FilterOrders()
    {
        return _allOrders.Where(x =>
            (selectedCategory == "All" || x.DeviceCategory == selectedCategory) &&
            (isCBAllOrdersSelected || x.CloseDate == null) &&
            (x.StartDate == null)
        ).ToList();
    }

    #endregion

    #region Scheduler
    private async Task OnCreateAppointment(SchedulerCreateEventArgs args)
    {

        if (args.Item is SchedulerAppointment newAppt && SchedulerRef != null)
        {
            var result = await ApptService.UpdateAppointment(newAppt);
            if (result.IsValid)
            {
                _allAppointments.Add(newAppt);
                Appointments.Add(newAppt);
                Console.WriteLine($"--- OnCreateAppointment: New appointment created. AssignedPerson: {newAppt.AssignedPerson}");
            }
            else
            {
                Console.WriteLine($"Failed to create appointment: {string.Join(", ", result.Errors)}");
            }
            SchedulerRef?.Rebind();
        }
    }

    private async Task OnUpdateAppointment(SchedulerUpdateEventArgs args)
    {
        if (args.Item is SchedulerAppointment updAppt)
        {
            var result = await ApptService.UpdateAppointment(updAppt);
            if (result.IsValid && result.Data != null)
            {
                var index = Appointments.FindIndex(a => a.AppointmentId == result.Data.WorkOrderID);
                if (index >= 0) Appointments[index] = new SchedulerAppointment(result.Data);

                var allIndex = _allAppointments.FindIndex(a => a.AppointmentId == result.Data.WorkOrderID);
                if (allIndex >= 0) _allAppointments[allIndex] = new SchedulerAppointment(result.Data);
                Console.WriteLine($"--- OnUpdateAppointment: Appointment updated. AssignedPerson: {updAppt.AssignedPerson}");
            }
            else
            {
                Console.WriteLine($"Failed to update appointment: {string.Join(", ", result.Errors)}");
            }
            SchedulerRef?.Rebind();
        }
    }

    private async Task OnDeleteAppointment(SchedulerDeleteEventArgs args)
    {

        if (args.Item is SchedulerAppointment delAppt)
        {
            var result = await ApptService.RemoveAppointment(delAppt);
            if (!result.IsValid)
            {
                string errors = string.Join(Environment.NewLine, result.Errors);
                popupMessage = errors ?? Localizer["Scheduler_FailedToCloseAppointment"];
                PopupRef?.Show();
                Console.WriteLine($"Failed to delete appointment: {string.Join(", ", result.Errors)}");
                return; 
            }
            _allAppointments.RemoveAll(a => a.AppointmentId == delAppt.AppointmentId);
            await LoadData();
            SchedulerRef?.Rebind();

        }
    }

    private void OnClearFilters()
    {
        selectedDepartments = new List<string> ();
        selectedAssetNo = "All";
        selectedAssignedPersons = new();
        DisplayAppointments();
    }

    async Task RefreshData(SchedulerAppointment? editedAppointment)
    {
        if (editedAppointment == null)
        {
            customEditFormShown = false;
            isOrderCardOpen = false;
            return;
        }
        else
        {
            var index = _allAppointments.FindIndex(a => a.AppointmentId == editedAppointment.AppointmentId);
            if (index != -1)
            {
                _allAppointments[index] = editedAppointment;
            }
            else
                _allAppointments.Add(editedAppointment);
        }
        customEditFormShown = false;
        isOrderCardOpen = false;
        await LoadData();
        SchedulerRef?.Rebind();
    }

    void EditHandler(SchedulerEditEventArgs args)
    {
        args.IsCancelled = true;
        SchedulerAppointment item = args.Item as SchedulerAppointment;
        if (!args.IsNew)
        {
            CurrentAppointment = item;
        }
        else
        {
            bool isStartEqualsEnd = args.Start == args.End;
            CurrentAppointment = item ?? new SchedulerAppointment();
            CurrentAppointment.Start = isStartEqualsEnd ? args.Start.AddHours(8) : args.Start;
            CurrentAppointment.End = isStartEqualsEnd ? args.End.AddHours(16) : args.End;
            CurrentAppointment.IsAllDay = item?.IsAllDay ?? true;

        }
        customEditFormShown = true;
    }

    void CancelEditing()
    {
        customEditFormShown = false;
        isOrderCardOpen = false;
    }

    private void OnSchedulerCellRender(SchedulerCellRenderEventArgs args)
    {
        if (CurrentView == SchedulerView.Month)
        {
            args.Class = "month-view-slot";
            if (args.Start.Date == DateTime.Today)
            {
                args.Class += " current-day";
            }
            else if (args.Start.DayOfWeek == DayOfWeek.Saturday || args.Start.DayOfWeek == DayOfWeek.Sunday)
            {
                args.Class += " weekend-day";
            }
        }
    }

    #endregion

    #region Grid Row Styles

    void OnRowRenderHandler(GridRowRenderEventArgs args)
    {
    }
    void OnRowClick(GridRowClickEventArgs args)
    {
        var item = args.Item as WorkOrder;
        if (item != null)
        {
            CurrentOrder = item;
            CurrentAppointment = new SchedulerAppointment(item);
            
            customEditFormShown = true;
            StateHasChanged();
        }
    }
    #endregion

    private MarkupString RenderStatesStyle(List<WorkOrder> orders)
    {
        var uniqueColors = orders
           .Select(o => o.StateColor)
           .Where(c => !string.IsNullOrWhiteSpace(c))
           .Distinct();

        var sb = new StringBuilder();
        sb.AppendLine("<style>");
        foreach (var color in uniqueColors)
        {
            var safeName = color.TrimStart('#');
            if (!UserState.UseOriginalColors)
                switch (safeName.ToLowerInvariant())
                {
                    case "lime":
                    case "1bf151":
                        safeName = "LightGreen";
                        break;
                    case "red":
                        safeName = "LightCoral";
                        break;
                    case "yellow":
                    case "ffff80":
                        safeName = "LightYellow";
                        break;
                    case "silver":
                        safeName = "LightSteelBlue";
                        break;
                    default:
                        break;
                }
            else
                safeName = color;
            sb.AppendLine($".state-{color.TrimStart('#')} {{");
            sb.AppendLine($"    background-color: {safeName};");
            sb.AppendLine("}");
        }
        sb.AppendLine("</style>");

        return new MarkupString(sb.ToString());
    }
    public class Resource
    {
        public string Text { get; set; }
        public string Value { get; set; }
        public string Color { get; set; } // must be a valid CSS string
    }

    private async Task FilterByDateRange(Telerik.Blazor.Components.FilterMenuTemplateContext context, string field, string range)
    {
        DateTime now = DateTime.Now;
        DateTime from = now;
        switch (range)
        {
            case "year":
                from = now.AddYears(-1);
                break;
            case "quarter":
                from = now.AddMonths(-3);
                break;
            case "month":
                from = now.AddMonths(-1);
                break;
        }
        var filterDescriptor = context.FilterDescriptor;
        filterDescriptor.FilterDescriptors.Clear();
        filterDescriptor.LogicalOperator = Telerik.DataSource.FilterCompositionLogicalOperator.And;
        filterDescriptor.FilterDescriptors.Add(new FilterDescriptor()
        {
            Member = field,
            Operator = Telerik.DataSource.FilterOperator.IsGreaterThanOrEqualTo,
            MemberType = typeof(DateTime),
            Value = from
        });
        await context.FilterAsync();
    }

    private async Task OnTimelineOptionChanged(string option)
    {
        selectedTimelineOption = option;
        if (option == "Custom")
        {
            showCustomTimelineInputs = true;
        }
        else
        {
            showCustomTimelineInputs = false;
            if (int.TryParse(option, out int days))
            {
                switch (days)
                {
                    case 1:
                        columnWidth = 70;
                        slotDuration = 45;
                        slotDivisions = 1;
                        break;
                    case 3:
                        columnWidth = 70;
                        slotDuration = 135;
                        slotDivisions = 1;
                        break;
                    case 5:
                        columnWidth = 50;
                        slotDuration = 180;
                        slotDivisions = 1;
                        break;
                    case 7:
                        columnWidth = 60;
                        slotDuration = 360;
                        slotDivisions = 1;
                        break;
                    case 14:
                        columnWidth = 90;
                        slotDuration = 900;
                        slotDivisions = 1;
                        break;
                    default:
                        break;
                }
                numberOfDays = days;
            }
        }
        await InvokeAsync(StateHasChanged);
        SchedulerRef?.Rebind();
        _saveStateTimer?.Change(SaveStateDelay, Timeout.Infinite);
    }

    private void InitializeSaveStateTimer()
    {
        _saveStateTimer = new(async _ =>
        {
            await ViewSettingsService.SaveSettingsAsync(SchedulerSettingsKey, _viewSettings);
            await SaveAllSettingsToServer();
        }, null, Timeout.Infinite, Timeout.Infinite);
    }

    public async ValueTask DisposeAsync()
    {
        if (_saveStateTimer is not null)
        {
            await _saveStateTimer.DisposeAsync();
        }
        if (_navSubscribed)
        {
            Navigation.LocationChanged -= OnLocationChanged;
            _navSubscribed = false;
        }
        await DisposeTimerAsync();
    }

    private async Task SaveAllSettingsToServer()
    {
        if (UserState == null || string.IsNullOrEmpty(UserState.UserName)) return;
        foreach (var key in ViewSettingsService.SettingsKeys.Values)
        {
            var viewSettings = await ViewSettingsService.LoadSettingsAsync<WorkOrder>(key);
            await apiService.SaveViewSettingsAsync(UserState.UserName, key, viewSettings);
        }
    }
    #region Context Menu
    private TelerikContextMenu<ContextMenuItem>? ContextMenuRef { get; set; }
    private List<ContextMenuItem> MenuItems { get; set; } = new();
    private SchedulerSlotTemplateContext? _clickedSlotContext;
    private SchedulerAppointment? _clickedAppointment;

    private async Task ShowContextMenuFromEmptySlot(MouseEventArgs e, SchedulerSlotTemplateContext slotContext)
    {
        _clickedSlotContext = slotContext;
        _clickedAppointment = null;
        MenuItems = new List<ContextMenuItem>();
        if (UserState.HasPermission(PermissionType.WO_Add))
        {
            MenuItems.Add(new ContextMenuItem { Text = @Localizer["Scheduler_AddNew"], Value = "Add", Icon = SvgIcon.Plus });
        }
        else
        {
            MenuItems.Add(new ContextMenuItem { Text = @Localizer["NoActionsAvailable"], Value = "NoActionsAvailable", Icon = SvgIcon.CancelOutline });
        }
        await ContextMenuRef?.ShowAsync(e.ClientX, e.ClientY)!;
    }

    private async Task ShowContextMenuFromAppointment(MouseEventArgs e, SchedulerAppointment appointment)
    {
        _clickedAppointment = appointment;
        _clickedSlotContext = null;
        MenuItems = new List<ContextMenuItem>
        {
            new ContextMenuItem { Text = @Localizer["Scheduler_Open"], Value = "Open", Icon = SvgIcon.FolderOpen }            
        };

        if (UserState.HasPermission(PermissionType.WO_Add))
        {
            new ContextMenuItem { Text = @Localizer["Scheduler_Duplicate"], Value = "Duplicate", Icon = SvgIcon.Copy };
        }

        if (UserState.HasPermission(PermissionType.WO_Edit))
        {
            new ContextMenuItem { Text = @Localizer["Scheduler_Remove"], Value = "Remove", Icon = SvgIcon.Trash };
        }

        await ContextMenuRef?.ShowAsync(e.ClientX, e.ClientY)!;
    }

    private void OnMenuItemClick(ContextMenuItem item)
    {
        switch (item.Value)
        {
            case "Add":
                OnAddAppointment();
                break;
            case "Open":
                OnOpenAppointment();
                break;
            case "Remove":
                OnRemoveAppointment();
                break;
            case "Duplicate":
                OnDuplicateAppointment();
                break;
        }
    }

    private void OnAddAppointment()
    {
        Console.WriteLine($"[{currentUser}]:  Adding new appointment at {_clickedSlotContext?.Start}");
        if (_clickedSlotContext != null)
        {
            bool isStartEqualsEnd = _clickedSlotContext.Start == _clickedSlotContext.End;
            CurrentAppointment = new SchedulerAppointment()
            {
                Start = isStartEqualsEnd ? _clickedSlotContext.Start.AddHours(8) : _clickedSlotContext.Start,
                End = isStartEqualsEnd ? _clickedSlotContext.Start.AddHours(16) : _clickedSlotContext.End,
                IsAllDay = true
            };
            if (_clickedSlotContext.Resources != null && _clickedSlotContext.Resources.Any())
            {
                var personResource = _clickedSlotContext.Resources.FirstOrDefault(r => r.Key == "AssignedPerson");
                if (personResource.Key != null && personResource.Value is string personName)
                {
                    CurrentAppointment.AssignedPerson = personName;
                }
            }
            customEditFormShown = true;
            StateHasChanged();
        }
    }

    private void OnOpenAppointment()
    {
        Console.WriteLine($"[{currentUser.Name}]:  Open appointment: {_clickedAppointment?.Title}");
        if (_clickedAppointment != null)
        {
            CurrentAppointment = _clickedAppointment;
            customEditFormShown = true;
        }
    }

    private async Task OnRemoveAppointment()
    {
        Console.WriteLine($"[{currentUser.Name}]:  Remove appointment: {_clickedAppointment?.Title}");
        if (_clickedAppointment != null)
        {
            var args = new SchedulerDeleteEventArgs(_clickedAppointment);
            await OnDeleteAppointment(args);
        }
    }

    private void OnDuplicateAppointment()
    {
        Console.WriteLine($"[{currentUser.Name}]:  Duplicate appointment: {_clickedAppointment?.Title}");
        if (_clickedAppointment != null)
        {
            var duplicatedAppointment = _clickedAppointment.ShallowCopy();
            duplicatedAppointment.AppointmentId = 0; 
            CurrentAppointment = duplicatedAppointment;
            customEditFormShown = true;

        }
    }

    public class ContextMenuItem
    {
        public string Text { get; set; }
        public string Value { get; set; }
        public object? Icon { get; set; }
    }
    #endregion
}
